import React, { Fragment } from 'react'
import { Field } from 'redux-form'
import _ from 'lodash'
import moment from 'moment'
import cx from 'classnames'
import PropTypes from 'prop-types'
import { Icon } from '@fc/react-playbook'

import OrdersValidationFactory from './OrdersValidationFactory'
import { getLongAccount } from '../../utils/Stringify'
// import CurrencyRenderer from '../../renderers/CurrencyRenderer'
import TimeFormatter from '../TimeFormatter/TimeFormatter'
import s from './Order.scss'
import ValueField from '../ValueField'

const generateValidationDetailsIndex = index => index
const getValidationDetails = values => {
  const validations = new OrdersValidationFactory(values)
  const validationDetails = validations.getAllValidationsForGridView()
  return (
    <div>
      {validationDetails.map((error, index) => (
        <div key={generateValidationDetailsIndex(index)}>
          <Icon name={error.iconClass} className={cx(s.warning)} />
          {error.message}{' '}
        </div>
      ))}
    </div>
  )
}

const formatSelectedTradeWindowDisplayText = (entity, timeZone) => {
  const {
    label,
    redEndTime,
    subEndTime,
    redemptionSettlementPeriod,
    subscriptionSettlementPeriod,
  } = entity.tradeWindow

  const tz = moment.tz(timeZone).zoneAbbr()
  return label ? (
    <span style={{ fontWeight: 400 }}>{label}</span>
  ) : (
    <Fragment>
      <span style={{ fontWeight: 400 }}>Window Cutoff </span>
      <span style={{ paddingRight: '5px' }}>
        ({tz}
        ):
      </span>
      <span>Buy:</span>
      <TimeFormatter time={subEndTime} showTimeZone={false} />
      <span style={{ paddingLeft: '5px', paddingRight: '5px' }}> | </span>
      <span>Sell:</span>
      <TimeFormatter time={redEndTime} showTimeZone={false} />
      <br />
      <span style={{ paddingRight: '23px' }}>Settlement Period: </span>
      <span style={{ paddingRight: '5px' }}>
        (T+
        {subscriptionSettlementPeriod})
      </span>
      <span style={{ paddingLeft: '27px', paddingRight: '5px' }}> | </span>
      <span>
        (T+
        {redemptionSettlementPeriod})
      </span>
    </Fragment>
  )
}

const order = props => {
  const { value, selectedAccountEntity } = props
  const showValidations =
    value.tradeBusinessRulesValidationErrors.length ||
    value.tradeComplianceRulesValidationErrors.length
  // || value.tradeInputValidationErrors.length
  console.log(
    '51----------------------- Order.js ',
    value,
    selectedAccountEntity,
  )
  return (
    <div className={s.confirmOrderWrap}>
      <div className={s.form}>
        <div className={s.column}>
          {props.fundName ? <div className={s.fund}>{props.fundName}</div> : ''}
          <div className={cx(s.row, s.accountInfo)}>
            <Field
              name="account"
              props={{
                formGroupClassName: s.account,
                inline: true,
                showDelimiter: true,
                label: 'Account',
                renderer: () => (
                  <div>
                    {getLongAccount(_.get(selectedAccountEntity, 'account'))}
                  </div>
                ),
              }}
              component={ValueField}
            />
            <Field
              props={{
                formGroupClassName: s.currencyField,
                inline: true,
                showDelimiter: true,
                label: 'Market Value',
                renderer: () => (
                  <div>
                    {_.get(selectedAccountEntity, 'balance.balanceAmt')}
                  </div>
                ),
              }}
              name="Market Value"
              component={ValueField}
            />

            <Field
              props={{
                formGroupClassName: s.numericField,
                inline: true,
                showDelimiter: true,
                label: 'Total Share',
                renderer: () => (
                  <div>{_.get(selectedAccountEntity, 'balance.shares')}</div>
                ),
              }}
              name="Total Share"
              component={ValueField}
            />
            <Field
              props={{
                formGroupClassName: s.currencyField,
                inline: true,
                showDelimiter: true,
                label: 'Est. Market Value',
                renderer: () => (
                  <div>
                    {_.get(selectedAccountEntity, 'balance.balanceAmt')}
                  </div>
                ),
              }}
              component={ValueField}
              name="Est. Market Value"
            />
            <Field
              props={{
                formGroupClassName: s.numericField,
                inline: true,
                showDelimiter: true,
                label: 'Est. Share',
              }}
              name={_.get(selectedAccountEntity, 'estimatedShare')}
              component={ValueField}
            />
            <Field
              props={{
                formGroupClassName: s.percentageField,
                inline: true,
                showDelimiter: true,
                label: 'Fund % Owned',
                renderer: ({ val }) => (val ? `${val}%` : ''),
              }}
              name={_.get(selectedAccountEntity, 'fundPercentOwned')}
              component={ValueField}
            />
            <Field
              props={{
                formGroupClassName: s.currencyField,
                inline: true,
                showDelimiter: true,
                label: 'Est. Total Market Value',
                renderer: ({ val }) => (val ? `$${val}` : ''),
              }}
              name={_.get(selectedAccountEntity, 'estimatedTotalMarketValue')}
              component={ValueField}
            />
            <Field
              props={{
                formGroupClassName: s.numericField,
                inline: true,
                showDelimiter: true,
                label: 'Est. Total Share',
              }}
              name={_.get(selectedAccountEntity, 'estimatedTotalShare')}
              component={ValueField}
            />
          </div>
          <div className={cx(s.row, s.accountInfo)}>
            <Field
              name="side"
              props={{
                formGroupClassName: s.account,
                inline: true,
                showDelimiter: true,
                label: 'Order Side',
                renderer: () => <div>{value.orderRequest.side}</div>,
              }}
              component={ValueField}
            />
            {value.orderRequest.redemptionFeeType ? (
              <Field
                name="redemptionFeeType"
                props={{
                  formGroupClassName: s.account,
                  inline: true,
                  showDelimiter: true,
                  label: 'Redemption Type',
                  renderer: () => (
                    <div>{value.orderRequest.redemptionFeeType}</div>
                  ),
                }}
                component={ValueField}
              />
            ) : (
              ''
            )}
            <Field
              name="qtyType"
              props={{
                formGroupClassName: s.account,
                inline: true,
                showDelimiter: true,
                label: 'Quantity Type',
                renderer: () => <div>{value.orderRequest.qtyType}</div>,
              }}
              component={ValueField}
            />
            <Field
              name="quantity"
              props={{
                formGroupClassName: s.account,
                inline: true,
                showDelimiter: true,
                label: 'Amount',
                renderer: () => <div>{value.orderRequest.quantity}</div>,
              }}
              component={ValueField}
            />
            {_.get(selectedAccountEntity, 'settlementDate') ? (
              <Field
                name="settlementDate"
                props={{
                  formGroupClassName: s.account,
                  inline: true,
                  showDelimiter: true,
                  label: 'Settlement Date',
                  renderer: () => (
                    <div>
                      {_.get(selectedAccountEntity, 'settlementDate.name')}
                    </div>
                  ),
                }}
                component={ValueField}
              />
            ) : (
              ''
            )}
            <Field
              name="tradeDate"
              props={{
                formGroupClassName: s.account,
                inline: true,
                showDelimiter: true,
                label: 'Trade Date',
                renderer: () => (
                  <div>{_.get(selectedAccountEntity, 'tradeDate')}</div>
                ),
              }}
              component={ValueField}
            />

            {showValidations ? (
              <Field
                name="validations"
                props={{
                  formGroupClassName: s.account,
                  inline: true,
                  showDelimiter: true,
                  label: 'Validations',
                  renderer: () => <div>{getValidationDetails(value)}</div>,
                }}
                component={ValueField}
              />
            ) : (
              ''
            )}
          </div>
          {selectedAccountEntity.tradeWindow ? (
            <div className={s.row}>
              <Field
                props={{
                  formGroupClassName: s.settlementFields,
                  inline: true,
                  showDelimiter: true,
                  label: 'Trade Window',
                  renderer: () => (
                    <div>
                      {formatSelectedTradeWindowDisplayText(
                        selectedAccountEntity,
                        'EDT',
                      )}
                    </div>
                  ),
                }}
                name="tradeWindow"
                component={ValueField}
              />
            </div>
          ) : (
            ''
          )}

          {value.orderRequest.investorCashSettlementInstruction ||
          value.orderRequest.investorCustodySettlementInstruction ? (
            <div className={cx(s.row, s.spaceBetween)}>
              {value.orderRequest.investorCashSettlementInstruction ? (
                <Field
                  props={{
                    formGroupClassName: s.settlementFields,
                    inline: true,
                    showDelimiter: true,
                    label: 'Cash Settlement Instructions',
                    renderer: () => (
                      <div>
                        <div>
                          {_.get(
                            selectedAccountEntity,
                            'cashSettlementInstructions.name',
                          )}
                        </div>
                        <div
                          style={{
                            lineHeight: '10pt',
                            fontSize: '11px',
                            textIndent: '10px',
                            backgroundColor: '#FFFFF0',
                            color: '#696969',
                          }}
                        >
                          <div>
                            <b>SSI Custodian Name:</b>
                            &nbsp;ASDFSDDS
                          </div>
                          <div>
                            <b>SSI Custodian Account:</b>
                            &nbsp;GGGG
                          </div>
                          <div>
                            <b>SSI Custodian BIC:</b>
                            &nbsp;DDDDDD66
                          </div>
                          <div>
                            <b>Cash Cutoff Time:</b>
                            &nbsp;22:00 US/Eastern
                          </div>
                        </div>
                      </div>
                    ),
                  }}
                  name="cashSettlementInstructions"
                  component={ValueField}
                />
              ) : (
                ''
              )}
              {value.orderRequest.investorCustodySettlementInstruction ? (
                <Field
                  props={{
                    formGroupClassName: s.settlementFields,
                    inline: true,
                    showDelimiter: true,
                    label: 'Custody Settlement Instructions',
                    renderer: () => (
                      <div>
                        {_.get(
                          selectedAccountEntity,
                          'custodySettlementInstructions.name',
                        )}
                      </div>
                    ),
                  }}
                  name="custodySettlementInstructions"
                  component={ValueField}
                />
              ) : (
                ''
              )}
            </div>
          ) : (
            ''
          )}
          {value.orderRequest.comments || value.orderRequest.approvalMessage ? (
            <div className={s.row}>
              {value.orderRequest.comments ? (
                <Field
                  props={{
                    formGroupClassName: s.settlementFields,
                    inline: true,
                    showDelimiter: true,
                    label: 'Comments',
                    renderer: () => <div>{value.orderRequest.comments}</div>,
                  }}
                  name="comments"
                  component={ValueField}
                />
              ) : (
                ''
              )}

              {value.orderRequest.approvalMessage ? (
                <Field
                  props={{
                    formGroupClassName: s.settlementFields,
                    inline: true,
                    showDelimiter: true,
                    label: 'Approval Messages',
                    renderer: () => (
                      <div>{value.orderRequest.approvalMessage}</div>
                    ),
                  }}
                  name="approvalMessage"
                  component={ValueField}
                />
              ) : (
                ''
              )}
            </div>
          ) : (
            ''
          )}
        </div>
      </div>
    </div>
  )
}
order.propTypes = {
  value: PropTypes.instanceOf(Object),
  selectedAccountEntity: PropTypes.instanceOf(Array),
  fundName: PropTypes.string,
}
export default order
